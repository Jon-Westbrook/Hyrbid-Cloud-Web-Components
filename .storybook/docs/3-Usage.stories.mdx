import { Meta } from '@storybook/addon-docs';
const linkButtonStyle = {
  display: 'inline-block',
  padding: '10px 25px',
  background: '#0062ff',
  color: 'white',
  textDecoration: 'none',
};
const linkButtonStyleSecondary = {
  ...linkButtonStyle,
  background: '#f4f4f4',
  color: 'black',
}

<Meta title="Usage" />

# Usage for Developers
Storybook encourages developing components in isolation, but how does on get from the component to the widget?

<img src="wr-flow.png" alt="Work Flow" title="Work Flow" />

## 1. Entry Point
The `.widgetRegistry/main.js` is the entry point for the widget compiler. It's `register` configuration instructs the
CLI to search for files ending in `.widget.js`.

This file is configured once. It is unlikely that `register` needs to be updated.

## 2. Widget Definition Files
Each widget will need a widget definition file, aka `my-thing.widget.js`. It contains the necessary metadata for the
widget, including the input parameters the content producers will need to populate when embedding the widget.

From the workflow perspective the most relevant entry is `registry`. This will point to a JS file that renders the
widget (a React app in the example) in the `<div>` that the CMS will print.

See [the widget definition file for the Trust Radius widget](https://github.ibm.com/MSC-Cloud/hc-widgets/blob/development/src/apps/trust-radius/TrustRadius.widget.js) below.

```javascript
// eslint-disable-next-line @typescript-eslint/no-var-requires
const path = require('path');

module.exports = {
  entry: path.join(__dirname, 'render-trust-radius.jsx'),
  shortcode: 'trust-radius',
  title: 'Trust Radius Reviews',
  status: 'stable',
  description: 'Lists product reviews retrieved from Trust Radius service.',
  settingsSchema: {
    type: 'object',
    properties: {
      fields: {
        type: 'object',
        properties: {
          'trust-radius-id': {
            type: 'string',
            title: 'Trust Radius ID',
            description:
              'The ID found within the trust radius reviews URL that activates the product reviews',
            examples: ['5e948b56fdfae40038b2b107'],
          },
          'use-google-stars': {
            type: 'boolean',
            title: 'Use Google Review Stars',
            description:
              'Enable Stars and review data on this pages Google search results? True or False',
            examples: [false, true],
          },
        },
      },
    },
  },
  additionalCustomProperties: {
    webSegmentPaths: ['/cloud'],
    availableTranslations: ['en', 'es', 'ja', 'ar'],
  },
};
```

See the full documentation for the widget definition file in the `@js-widgets/webpack-cli` documentation site.

<a style={linkButtonStyle} href='https://js-widgets.github.io/webpack-cli/docs/registry/widget-definition' target='_blank'>Read the docs</a>

## 3. Render Files
Widgets are stand alone JS applications, but a component library only has components. To bridge that gap we need to
create a render file. This is a file that will render a component in a `<div>` that the CMS will print on the page. The
JavaScript application will render inside that `<div>`.

Widgets will likely have to support translations and state management. Translations are handled by `react-intl`, and state management by `react-redux`.
See the [source code of the render file for the Trust Radius widget](https://github.ibm.com/MSC-Cloud/hc-widgets/blob/development/src/apps/trust-radius/render-trust-radius.jsx)
for an example on how to write your own.

<a style={linkButtonStyleSecondary} href='https://formatjs.io/docs/getting-started/installation/' target='_blank'>React Intl docs</a>
&nbsp;
<a style={linkButtonStyleSecondary} href='https://redux.js.org/introduction/getting-started' target='_blank'>Redux docs</a>

Common stateful features include:

  - [Setting the Carbon theme](https://github.ibm.com/MSC-Cloud/hc-widgets/blob/development/src/apps/trust-radius/lib/redux/reducers/setThemeReducer.ts).
  - [Fetching data from an API](https://github.ibm.com/MSC-Cloud/hc-widgets/blob/development/src/apps/trust-radius/lib/redux/actions/fetchProductDataAction.ts).
  - [Executing JS code on view port resize](https://github.ibm.com/MSC-Cloud/hc-widgets/blob/development/src/apps/trust-radius/lib/redux/reducers/windowResizeReducer.ts).

All these are implemented in the Trust Radius widget and can be abstracted to be leveraged in other widgets.

See the render file for the Trust Radius widget below.

```typescript
import React from 'react';
import ReactDOM from 'react-dom';
import { Provider } from 'react-redux';
import TrustRadius from './components/TrustRadius';
import store from './lib/redux/store';
import 'regenerator-runtime/runtime';
import { IntlProvider } from 'react-intl';
import normalizeWidgetInput from '../../common/normalizeWidgetInput';

/**
 * Renders the widget.
 *
 * @param {string} instanceId
 *   The already present HTML element ID where the react app will be rendered.
 * @param {string} langCode
 *   The language code for internationalization purposes.
 * @param {string} origin
 *   Protocol and hostname where a JSONAPI endpoint is available.
 * @param {Function} cb
 *   A callback that executes after the widget has been rendered.
 */
async function render(instanceId, langCode, origin, cb) {
  const { element, locale, messages, palette } = await normalizeWidgetInput(
    instanceId,
    langCode,
  );
  if (!element) {
    return;
  }
  const useGoogleStars =
    element.getAttribute('data-use-google-stars') !== 'false' ||
    element.getAttribute('data-use-google-stars') !== '0';
  ReactDOM.render(
    <React.StrictMode>
      <IntlProvider locale={locale} messages={messages}>
        <Provider store={store}>
          <TrustRadius
            trustRadiusId={element.getAttribute('data-trust-radius-id') || ''}
            theme={palette}
            useGoogleStars={useGoogleStars}
          />
        </Provider>
      </IntlProvider>
    </React.StrictMode>,
    element,
    () => cb(element),
  );
}

window.renderTrustRadius = render;
```

The `@js-widgets/webpack-cli` documentation contains more information on render files. Check it out for more insight.

<a style={linkButtonStyle} href='https://js-widgets.github.io/webpack-cli/docs/registry/render-file' target='_blank'>Read the docs</a>
